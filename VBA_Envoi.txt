Sub UpdateData()
    On Error GoTo ErrorHandler

    Dim olNamespace As Object
    Dim olInbox As Object
    Dim olSubfolder As Object
    Dim msg As Object
    Dim att As Object
    Dim strFilePath As String
    Dim strFileName As String
    Dim xlWorksheet As Worksheet
    Dim i As Integer

    ' Spécifiez le chemin où vous souhaitez enregistrer les pièces jointes
    strFilePath = "C:\Users\BC002424\Desktop\Komla Martin CHOKKI\Collecte des EF 2023\Retour\"

    ' Sélectionnez la feuille "Liste" dans le classeur actuel
    Set xlWorksheet = ThisWorkbook.Sheets("Liste")

    ' Effacez les anciennes données (en commençant par la deuxième ligne car la première ligne contient les en-têtes)
    xlWorksheet.Range("A2:C" & xlWorksheet.Cells(xlWorksheet.Rows.Count, 1).End(xlUp).Row).ClearContents

    ' Commencez à remplir les données à partir de la deuxième ligne
    i = 2

    ' Sélectionnez la boîte de réception
    Set olNamespace = CreateObject("Outlook.Application").GetNamespace("MAPI")
    Set olInbox = olNamespace.GetDefaultFolder(6) ' 6 = olFolderInbox

    ' Sélectionnez le sous-dossier "ETATS FINANCIERS"
    Set olSubfolder = olInbox.Folders("ETATS FINANCIERS")

    ' Vérification de la sélection du sous-dossier
    If olSubfolder Is Nothing Then
        MsgBox "Le sous-dossier 'ETATS FINANCIERS' est introuvable.", vbCritical
        Exit Sub
    End If

    ' Parcourez tous les e-mails du sous-dossier
    For Each msg In olSubfolder.Items
        ' Assurez-vous que l'élément est un mail (MailItem)
        If TypeName(msg) = "MailItem" Then
            ' Parcourez toutes les pièces jointes de l'e-mail
            For Each att In msg.Attachments
                ' Vérifiez si la pièce jointe n'est pas une image
                If Right(att.FileName, 4) <> ".jpg" And Right(att.FileName, 5) <> ".jpeg" And Right(att.FileName, 4) <> ".png" And Right(att.FileName, 4) <> ".gif" Then
                    ' Construisez le nom du fichier
                    strFileName = strFilePath & att.FileName

                    ' Enregistrez la pièce jointe sur le disque
                    att.SaveAsFile strFileName

                    ' Enregistrez le lien du fichier, l'adresse e-mail et l'objet dans le fichier Excel
                    xlWorksheet.Cells(i, 1).Value = strFileName
                    xlWorksheet.Cells(i, 2).Value = msg.SenderEmailAddress
                    xlWorksheet.Cells(i, 3).Value = msg.Subject

                    ' Message de débogage pour vérifier les valeurs
                    Debug.Print "Fichier enregistré : " & strFileName
                    Debug.Print "Email : " & msg.SenderEmailAddress
                    Debug.Print "Sujet : " & msg.Subject

                    i = i + 1
                End If
            Next att
        End If
    Next msg

    MsgBox "La macro s'est exécutée avec succès.", vbInformation
    Exit Sub

ErrorHandler:
    MsgBox "Une erreur s'est produite : " & Err.Description, vbCritical

    ' Libérer les objets
    Set olNamespace = Nothing
    Set olInbox = Nothing
    Set olSubfolder = Nothing
    Set msg = Nothing
    Set att = Nothing
    Set xlWorksheet = Nothing
End Sub
