Function CalculerNombreDemandesForcage(NumCompteClient As String, ByRef DerniereDateDemande As String) As Long
    On Error GoTo ErrorHandler

    ' Définir la chaîne de connexion à la base de données Access
    Dim conn As Object
    Dim rs As Object
    Dim query As String
    Dim connectionString As String
    Dim NbDemandes As Long

    connectionString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=C:\Users\user\OneDrive\Desktop\Forcage\Update\DemandesForcage.accdb;" ' Remplacez par le chemin correct

    ' Créer la connexion et le Recordset
    Set conn = CreateObject("ADODB.Connection")
    Set rs = CreateObject("ADODB.Recordset")

    ' Ouvrir la connexion
    conn.Open connectionString

    ' Définir la requête SQL pour compter les demandes de forçage uniques du client ce mois-ci et obtenir la dernière date de demande
    query = "SELECT COUNT(DISTINCT [DemandeForcageID]) AS NbDemandes, MAX([DateDemande]) AS DerniereDate FROM ValidationForcage WHERE [NumCompteClient] = '" & NumCompteClient & "' AND MONTH([DateDemande]) = MONTH(Date()) AND YEAR([DateDemande]) = YEAR(Date())"

    ' Ouvrir le Recordset
    rs.Open query, conn, 1, 3 ' 1 = adOpenKeyset, 3 = adLockOptimistic

    ' Récupérer le nombre de demandes et la dernière date
    If Not rs.EOF Then
        NbDemandes = rs.Fields("NbDemandes").Value
        DerniereDateDemande = rs.Fields("DerniereDate").Value
    Else
        NbDemandes = 0
        DerniereDateDemande = "Aucune"
    End If

    ' Fermer le Recordset et la connexion
    rs.Close
    conn.Close

    ' Libérer les objets
    Set rs = Nothing
    Set conn = Nothing

    ' Retourner le nombre de demandes
    CalculerNombreDemandesForcage = NbDemandes
    Exit Function

ErrorHandler:
    MsgBox "Erreur lors du calcul du nombre de demandes de forçage : " & Err.Description, vbCritical
    If Not rs Is Nothing Then rs.Close
    If Not conn Is Nothing Then
        conn.Close
        Set conn = Nothing
    End If
    Set rs = Nothing
    CalculerNombreDemandesForcage = 0
    DerniereDateDemande = "Erreur"
End Function



Function FormatRecapDemandeCompleteHTML(ID As Long, DateDemande As String, NumCompteClient As String, CodeGestionnaire As String, NomGestionnaire As String, CodeClient As String, NomClient As String, MontantAutorisation As Double, SoldeActuel As Double, MontantForcage As Double, SoldePostForcage As Double, MontantDepassement As Double, PourcentageDepassement As String, DateValidite As String, PromesseRegularisation As String, DateRegularisation As String, RepresentantClient As String, CommentairesCelluleForcage As String, Rating As String, Staging As String, TypeForcage As String, NatureEngagement As String, DureeIrregularite As String, NiveauValidation As String, TypeOperation As String) As String
    
    Dim MontantAutoStr As String
    Dim DateValiditeStr As String
    Dim NbDemandes As Long
    Dim DerniereDateDemande As String
    
    ' Vérifier et formater les valeurs
    If MontantAutorisation = 0 Then
        MontantAutoStr = "SANS AUTO"
    Else
        MontantAutoStr = FormatNumber(MontantAutorisation, 2)
    End If
    
    If DateValidite = "01/01/1900" Then
        DateValiditeStr = "PAS DVA"
    Else
        DateValiditeStr = DateValidite
    End If
    
    ' Calculer le nombre de demandes de forçage du client ce mois-ci et la dernière date de demande
    NbDemandes = CalculerNombreDemandesForcage(NumCompteClient, DerniereDateDemande)
    
    FormatRecapDemandeCompleteHTML = "<html><body>" & _
        "<p>Bonjour,</p>" & _
        "<p>Une nouvelle demande de forçage du client <b>" & NomClient & "</b> (Staging: <b>" & Staging & "</b> / Gest: <b>" & NomGestionnaire & "</b>), vous a été envoyée pour validation par la cellule forçage. La demande concerne une opération de type <b>" & TypeOperation & "</b>.</p>" & _
        "<table border='1'>" & _
        "<tr><td>Nom Client</td><td>" & NomClient & "</td></tr>" & _
        "<tr><td>Montant Autorisation</td><td><b><span style='background-color: yellow;'>" & MontantAutoStr & "</span></b></td></tr>" & _
        "<tr><td>Solde Actuel</td><td><b>" & FormatNumber(SoldeActuel, 2) & "</b></td></tr>" & _
        "<tr><td>Montant Forcage</td><td><b><span style='background-color: yellow;'>" & FormatNumber(MontantForcage, 2) & "</span></b></td></tr>" & _
        "<tr><td>Solde Post Forcage</td><td><b>" & FormatNumber(SoldePostForcage, 2) & "</b></td></tr>" & _
        "<tr><td>Montant Dépassement</td><td><b><span style='background-color: yellow;'>" & FormatNumber(MontantDepassement, 2) & "</span></b></td></tr>" & _
        "<tr><td>Pourcentage Dépassement</td><td><b><span style='background-color: yellow;'>" & PourcentageDepassement & "</span></b></td></tr>" & _
        "<tr><td>DVA</td><td>" & DateValiditeStr & "</td></tr>" & _
        "<tr><td>Promesse Régularisation</td><td><b><span style='background-color: yellow;'>" & PromesseRegularisation & "</span></b></td></tr>" & _
        "<tr><td>Delai de Regularisation</td><td><b>" & DureeIrregularite & " jours</b></td></tr>" & _
        "<tr><td>Représentant Client Contacté</td><td>" & RepresentantClient & "</td></tr>" & _
        "<tr><td>Commentaires Cellule Forcage</td><td>" & CommentairesCelluleForcage & "</td></tr>" & _
        "<tr><td>Rating</td><td>" & Rating & "</td></tr>" & _
        "<tr><td>Type Forcage</td><td>" & TypeForcage & "</td></tr>" & _
        "<tr><td>Nature Engagement Irrégulier</td><td><b><span style='background-color: yellow;'>" & NatureEngagement & "</span></b></td></tr>" & _
        "<tr><td>Nombre de demandes ce mois-ci</td><td><b>" & NbDemandes & "</b></td></tr>" & _
        "<tr><td>Dernière date de demande</td><td><b>" & DerniereDateDemande & "</b></td></tr>" & _
        "</table>" & _
        "<p>Cordialement,</p>" & _
        "<p><b>La cellule Forçage</b></p>" & _
        "</body></html>"
End Function
